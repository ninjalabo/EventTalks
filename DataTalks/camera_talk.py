# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/08_camera_talk.ipynb.

# %% ../nbs/08_camera_talk.ipynb 1
#| eval: false
from __future__ import annotations

import asyncio, datetime as dt, random, logging, os, contextlib
from .arena_agent import parking_q, history

from agents import Agent, Runner
from agents.mcp import MCPServerSse         

log = logging.getLogger(__name__)

MCP_URL   = os.getenv("MCP_URL",   "http://tools:9001/sse")
LOCATION  = os.getenv("LOCATION", "Helsinki,FI")   # city or "lat,lon"


# %% auto 0
__all__ = ['log', 'MCP_URL', 'LOCATION', 'parking_camera_loop']

# %% ../nbs/08_camera_talk.ipynb 2
#| eval: false
async def parking_camera_loop() -> None:
    "Send a Gen-UI block every 60 s."
    while True:
        free_slots = random.randint(0, 120)
        stamp      = dt.datetime.now().strftime("%H:%M:%S")

        ui_block   = await _make_ui_block(free_slots, stamp)

        # one SSE `message`
        sse = "event: message\ndata: " + ui_block.replace("\n", "\ndata: ") + "\n\n"
        await parking_q.put(sse)
        log.debug("parking-loop bubble @ %s", stamp)

        await asyncio.sleep(180)


# %% ../nbs/08_camera_talk.ipynb 3
#| eval: false
#from contextlib import asynccontextmanager

#@asynccontextmanager
#async def lifespan(app):
#    "Run the parking loop for the lifetime of the FastAPI app."
#    task = asyncio.create_task(parking_camera_loop(), name="parking-loop")
#    yield
#    task.cancel()
#    with contextlib.suppress(asyncio.CancelledError):
#        await task


# %% ../nbs/08_camera_talk.ipynb 4
#| eval: false
async def _make_ui_block(free_slots: int, stamp: str) -> str:
    """
    Generates a full GenUI HTML card via LLM using weather + parking.
    Ensures booking buttons and branding are always present.
    """
    async with MCPServerSse(name="ui", params={"url": MCP_URL}, client_session_timeout_seconds=300) as srv:
        
        instructions = f"""
        ğŸ¨ You are EcoGen, a generative-UI designer.
        
        You will craft **one complete MonsterUI/Tailwind card** and stream it via HTMX *exactly once*.
        
        Inputs this run
        â€¢ ğŸ…¿ï¸  {free_slots} free parking slots
        â€¢ ğŸ•’  Current time: {stamp}
        â€¢ ğŸŒ¤ï¸  Live weather for â€œ{LOCATION}â€
        
        Stepâ€‘byâ€‘step
        1. **Call `weather.current` once.**  Parse `temperature` (Â°C), `windspeed` (m/s) and `description`.
        
        2. **Call `ImageGenerationTool` once** with a tiny prompt such as â€œbright sun on white backgroundâ€.  When the JSON returns, extract
           â€¢ `url`  â€“ image URL  
           and put it straight into an `<img>` tag â€“ **no {{curly}} placeholders**:
        
           ```html
           <img class="rounded-lg object-cover w-32 h-32 float-right ml-4"
                src="https://â€¦real-urlâ€¦" alt="bright sun on white background">
           ```
        
        3. **Compose one HTML block** wrapped in
        
           ```html
           <div hx-swap-oob="beforeend:#chatlog">
             â€¦full cardâ€¦
           </div>
           ```
        
           It must contain, in order:
           â€¢ A fun heading with an emoji  
           â€¢ Weather summary (temp + wind + description + the image)  
           â€¢ Parking status line, e.g. `ğŸš— 40 free slots`  
           â€¢ A friendly encouragement paragraph  
           â€¢ **Exactly three** booking buttons, styled `btn btn-success btn-sm`, linking to:
             â€“ Cityâ€¯BikesÂ (HSL)Â â†’Â https://kaupunkipyorat.hsl.fi/en  
             â€“ Donkeyâ€¯RepublicÂ â†’Â https://app.donkeyrepublic.com/#/reserve  
             â€“ ListNRideÂ â†’Â https://www.listnride.com/espoo  
             Place them inside
        
           ```html
           <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mt-4">â€¦</div>
           ```
        
           â€¢ Footer line â€œWheel be seeing you! ğŸŒ±â€  
           â€¢ Branding footer
        
           ```html
           <div class="text-xs text-center text-gray-400 mt-3">Powered by EventTalks ğŸ’ğŸŒ</div>
           ```
        
        Rules
        â€¢ **HTML only** â€“ no Markdown, no JSON.  
        â€¢ Produce a single response; do **not** send drafts.  
        â€¢ Missing any mandatory element â‡’ response rejected.
        """
        agent = Agent(
            name="EcoGen Agent",
            model="o3",
            mcp_servers=[srv],
            
            instructions=instructions,
        )

        res = await Runner.run(agent, input="")
        ui = res.final_output.strip()

    # Safety net: wrap if LLM forgot
    if "hx-swap-oob" not in ui:
        ui = f'<div hx-swap-oob="beforeend:#chatlog">{ui}</div>'

    # Safety net: inject buttons if missing
    if all(x not in ui for x in ["City Bikes", "Donkey Republic", "ListNRide"]):
        ui += """
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mt-4">
          <a href="https://kaupunkipyorat.hsl.fi/en"               class="btn btn-success btn-sm">ğŸš² City Bikes (HSL)</a>
      <a href="https://app.donkeyrepublic.com/#/reserve"       class="btn btn-success btn-sm">ğŸ¦„ Donkey Republic</a>
     <a href="https://www.listnride.com/espoo"                class="btn btn-success btn-sm">ğŸš´ ListNRide</a>
            </div>
        """

    # Branding if missing
    if "EventTalks" not in ui:
        ui += '<div class="text-xs text-center text-gray-400 mt-3">Powered by EventTalks ğŸ’ğŸŒ</div>'

    history.append(ui)
    return ui




