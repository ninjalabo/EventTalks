# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/08_camera_talk.ipynb.

# %% ../nbs/08_camera_talk.ipynb 1
#| eval: false
from __future__ import annotations

import asyncio, datetime as dt, random, logging, os, contextlib
from .arena_agent import parking_q, history

from agents import Agent, Runner
from agents.mcp import MCPServerSse         

log = logging.getLogger(__name__)

MCP_URL   = os.getenv("MCP_URL",   "http://tools:9001/sse")
LOCATION  = os.getenv("LOCATION", "Helsinki,FI")   # city or "lat,lon"


# %% auto 0
__all__ = ['log', 'MCP_URL', 'LOCATION', 'parking_camera_loop', 'lifespan']

# %% ../nbs/08_camera_talk.ipynb 2
#| eval: false
async def parking_camera_loop() -> None:
    "Send a Gen-UI block every 60 s."
    while True:
        free_slots = random.randint(0, 120)
        stamp      = dt.datetime.now().strftime("%H:%M:%S")

        ui_block   = await _make_ui_block(free_slots, stamp)

        # one SSE `message`
        sse = "event: message\ndata: " + ui_block.replace("\n", "\ndata: ") + "\n\n"
        await parking_q.put(sse)
        log.debug("parking-loop bubble @ %s", stamp)

        await asyncio.sleep(60)


# %% ../nbs/08_camera_talk.ipynb 3
#| eval: false
from contextlib import asynccontextmanager

@asynccontextmanager
async def lifespan(app):
    "Run the parking loop for the lifetime of the FastAPI app."
    task = asyncio.create_task(parking_camera_loop(), name="parking-loop")
    yield
    task.cancel()
    with contextlib.suppress(asyncio.CancelledError):
        await task


# %% ../nbs/08_camera_talk.ipynb 4
#| eval: false
async def _make_ui_block(free_slots: int, stamp: str) -> str:
    """
    The agent:
      â€¢ calls the **weather.current** tool for `LOCATION`
      â€¢ if weather is bike-friendly â‡’ encourages renting a bike
      â€¢ else suggests an umbrella / tram / etc.
      â€¢ returns *complete* UI (HTML / C1 JSON / Monster-UI)
      â€¢ outermost tag must carry `hx-swap-oob="beforeend:#chatlog"`
    """
    # give the LLM access to the weather tool via MCP SSE
    async with MCPServerSse(name="ui", params={"url": MCP_URL},
                            client_session_timeout_seconds=300) as srv:
        _instructions = f"""
        ðŸ”‘  Context the model MUST rely on
        ---------------------------------
        â€¢ live_weather   â†’ output of tool weather.current (location='{LOCATION}')
        â€¢ free_slots     â†’ integer {free_slots}
        â€¢ timestamp      â†’ string {stamp}
        â€¢ parking_tight  â†’ free_slots < 30          # Â«lots filling upÂ»
        â€¢ weather_good   â†’ 5 â‰¤ temp â‰¤ 30 Â°C, wind < 8 m/s, no rain/snow
        
        ðŸŽ¯  Goal
        -------
        Craft ONE chat-ready UI component that:
        1. Reports the parking and weather status.
        2. Encourages the user to choose an e-bike **because it is greener**
           â€” but adapts the persuasion if weather is bad or slots are plentiful.
        3. Offers at least ONE action path (button or link) to book an e-bike.
        
        ðŸ—  Hard (non-negotiable) technical rules
        â€¢ Output *only* valid HTML (or a C1/Monster-UI JSON block).
        â€¢ The outermost element MUST contain:  hx-swap-oob="beforeend:#chatlog"
        â€¢ Do NOT wrap anything in Markdown.
        â€¢ Do NOT call any tool except weather.current.
        
        ðŸ§©  Soft constraints (creative freedom inside)
        â€¢ You MAY use any Monster-UI or Tailwind classes, any emojis, any micro-copy.
        â€¢ You MAY add a lightweight animation or playful image/GIF if <150 KB.
        â€¢ You MAY choose colors, gradients, shadows as you like.
        â€¢ You MAY decide the exact wording: punny, poetic, minimalâ€”your style.
        â€¢ You MAY reorder elements (buttons first, banner first, etc.).
        â€¢ If weather_good is False you MAY tone down persuasion or grey-out buttons.
        
        ðŸ”—  Reliable booking links (use any subset â‰¥1)
          â€“ Roll Outdoors   â†’ https://rolloutdoors.com/en/helsinki/#rent
          â€“ Donkey Republic â†’ https://app.donkeyrepublic.com/#/reserve
          â€“ ListNRide       â†’ https://www.listnride.com/helsinki
        
        ðŸ’¡  Inspiration tips (OPTIONAL, not mandatory)
        â€¢ Use an eco catch-phrase like â€œSwap cars for green bars!â€.
        â€¢ Show a mini progress bar if parking_tight is True.
        â€¢ Add a hover tooltip to explain why biking saves COâ‚‚.
        
        âœï¸  Deliverable
        Return the final UI markup **and nothing else**.
        """
        instructions = f"""
ðŸŒ±  Youâ€™re *Arena Eco-Coach*, free to design any Monster-UI/Tailwind card
    you like â€“ but you MUST embed real data, never {{mustache}} placeholders.

ðŸ”§  Required workflow
1. Call tool **weather.current** exactly once for location '{LOCATION}'.
2. Read its JSON â†’ temp_c, description, wind_m_s.
3. Compute:
     weather_good   = 5 â‰¤ temp_c â‰¤ 30  and  wind_m_s < 8  and  no rain/snow
     parking_tight  = {free_slots} < 30
4. Build ONE HTML card (root element must include
   hx-swap-oob="beforeend:#chatlog").  The card must contain:
   â€¢ Parking line â€“ show **{free_slots} free slots** with ðŸ…¿ï¸ emoji.
   â€¢ Weather line â€“ insert the actual numbers
     `temp_c`, `description`, `wind_m_s`.
     ðŸ‘‰ Do **not** output curly-brace templates or raw JSON.
   â€¢ Persuasion sentence that adapts:
       â€“ If weather_good & parking_tight â†’
         â€œSlots are scarce and the sun is shining â€“ ride green!â€ (or similar).
       â€“ Adapt wording for the other three weather/parking combinations.
   â€¢ 1â€“3 action buttons linking to:
       Roll Outdoors   https://rolloutdoors.com/en/helsinki/#rent
       Donkey Republic https://app.donkeyrepublic.com/#/reserve
       ListNRide       https://www.listnride.com/helsinki
     â€“ If weather_good is **False**, add class="btn btn-disabled"
       and a tooltip explaining why.
   â€¢ Fun footer pun (text-xs).
   â€¢ Optional lightweight animation (< 150 KB) if you wish.
5. You may choose any colours, emojis, layout, humour style.
6. Final output = raw HTML only, no markdown, no {{templates}}.
"""


        agent = Agent(
            name="UI Agent",
            model="o3",
            mcp_servers=[srv],
            instructions=instructions,
        )

        res = await Runner.run(agent, input="")
        ui  = res.final_output.strip()

    # safety net: inject hx-swap-oob if the model forgot
    if "hx-swap-oob" not in ui:
        ui = f'<div hx-swap-oob="beforeend:#chatlog">{ui}</div>'

    history.append(ui)
    return ui


# %% ../nbs/08_camera_talk.ipynb 5
#| eval: false 
from contextlib import asynccontextmanager

@asynccontextmanager
async def lifespan(app):
    "Run the parking loop for the lifetime of the FastAPI app."
    task = asyncio.create_task(parking_camera_loop(), name="parking-loop")
    yield
    task.cancel()
    with contextlib.suppress(asyncio.CancelledError):
        await task

